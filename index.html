<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PDF Viewer</title>
  <style>
    html, body { margin: 0; height: 100%; background: #0b0c10; }
    #stage {
      position: fixed; inset: 0; display: grid; place-items: center;
      overflow: hidden;
    }
    canvas { display: block; background: #fff; box-shadow: 0 8px 24px rgba(0,0,0,.35); }
    /* Minimal icon-only controls */
    #ctl {
      position: fixed; right: 12px; bottom: 12px;
      display: flex; gap: 8px; padding: 8px;
      background: rgba(0,0,0,.35); backdrop-filter: blur(6px);
      border-radius: 999px;
    }
    #ctl button {
      width: 36px; height: 36px; border-radius: 50%;
      border: none; background: rgba(255,255,255,.12); color: #eaeaea;
      font-size: 18px; cursor: pointer; display: grid; place-items: center;
    }
    #ctl button:hover { background: rgba(255,255,255,.22); }
    /* Hide any text labels; icons only */
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
  </style>
</head>
<body>
  <script>
    // 默认：同目录 file.pdf。也可通过 ?pdf= 指定：index.html?pdf=docs/a.pdf
    const url = new URL(location.href);
    const PDF_URL = url.searchParams.get("pdf") || "Slides/Theoryday.pdf";
  </script>

  <div id="stage"><canvas id="page"></canvas></div>

  <!-- Icon-only controls -->
  <div id="ctl">
    <button id="prev" title="上一页" aria-label="上一页">⟨<span class="sr-only">Prev</span></button>
    <button id="next" title="下一页" aria-label="下一页">⟩<span class="sr-only">Next</span></button>
    <button id="zoomOut" title="缩小" aria-label="缩小">−<span class="sr-only">Zoom out</span></button>
    <button id="zoomIn" title="放大" aria-label="放大">＋<span class="sr-only">Zoom in</span></button>
    <button id="fitW" title="适宽" aria-label="适宽">↔<span class="sr-only">Fit width</span></button>
    <button id="fitP" title="整页" aria-label="整页">⤢<span class="sr-only">Fit page</span></button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    const canvas = document.getElementById("page");
    const ctx = canvas.getContext("2d", { alpha: false });
    const stage = document.getElementById("stage");
    const btnPrev = document.getElementById("prev");
    const btnNext = document.getElementById("next");
    const btnIn = document.getElementById("zoomIn");
    const btnOut = document.getElementById("zoomOut");
    const btnFitW = document.getElementById("fitW");
    const btnFitP = document.getElementById("fitP");

    let pdf = null;
    let current = 1;
    let scale = 1.0;         // CSS 逻辑缩放
    let mode = "fitWidth";   // fitWidth | fitPage | custom

    function dpr() { return Math.min(3, window.devicePixelRatio || 1); } // 限制上限，防止超高 DPR 过慢

    async function render() {
      if (!pdf) return;
      const page = await pdf.getPage(current);

      // 先按 1 渲染视口，用于计算
      const vp1 = page.getViewport({ scale: 1 });

      // 根据模式计算 CSS 缩放
      const padding = 24; // 视觉边距
      const maxW = window.innerWidth - padding * 2;
      const maxH = window.innerHeight - padding * 2;
      if (mode === "fitWidth") {
        scale = Math.min(maxW / vp1.width, 3);
      } else if (mode === "fitPage") {
        scale = Math.min(maxW / vp1.width, maxH / vp1.height);
      } // custom 模式使用当前 scale

      // 实际渲染 scale 叠加 DPR，确保清晰
      const pixelScale = scale * dpr();
      const vp = page.getViewport({ scale: pixelScale });

      // 画布像素尺寸
      canvas.width = Math.round(vp.width);
      canvas.height = Math.round(vp.height);
      // CSS 展示尺寸（不带 DPR）
      canvas.style.width = Math.round(vp.width / dpr()) + "px";
      canvas.style.height = Math.round(vp.height / dpr()) + "px";

      // 清屏并渲染
      ctx.setTransform(1,0,0,1,0,0);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      await page.render({ canvasContext: ctx, viewport: vp }).promise;
    }

    function clampPage(n) { return Math.max(1, Math.min(pdf.numPages, n)); }

    // 控件事件
    btnPrev.addEventListener("click", () => { current = clampPage(current - 1); render(); });
    btnNext.addEventListener("click", () => { current = clampPage(current + 1); render(); });
    btnIn.addEventListener("click", () => { mode = "custom"; scale = Math.min(scale + 0.1, 5); render(); });
    btnOut.addEventListener("click", () => { mode = "custom"; scale = Math.max(scale - 0.1, 0.2); render(); });
    btnFitW.addEventListener("click", () => { mode = "fitWidth"; render(); });
    btnFitP.addEventListener("click", () => { mode = "fitPage"; render(); });

    // 键盘快捷键：←/→ 翻页；Ctrl+滚轮 缩放；F 宽度/整页切换
    window.addEventListener("keydown", e => {
      if (!pdf) return;
      if (e.key === "ArrowLeft") { current = clampPage(current - 1); render(); }
      else if (e.key === "ArrowRight") { current = clampPage(current + 1); render(); }
      else if ((e.ctrlKey || e.metaKey) && (e.key === "=" || e.key === "+")) { mode = "custom"; scale = Math.min(scale + 0.1, 5); render(); }
      else if ((e.ctrlKey || e.metaKey) && (e.key === "-")) { mode = "custom"; scale = Math.max(scale - 0.1, 0.2); render(); }
      else if (e.key.toLowerCase() === "f") { mode = (mode === "fitWidth" ? "fitPage" : "fitWidth"); render(); }
      else if (e.key === "PageDown" || e.key === " ") { current = clampPage(current + 1); render(); }
      else if (e.key === "PageUp") { current = clampPage(current - 1); render(); }
    });

    // Ctrl+滚轮缩放（不显示任何提示文字）
    window.addEventListener("wheel", e => {
      if (!pdf) return;
      if (e.ctrlKey) {
        e.preventDefault();
        mode = "custom";
        scale = e.deltaY < 0 ? Math.min(scale + 0.1, 5) : Math.max(scale - 0.1, 0.2);
        render();
      }
    }, { passive: false });

    // 尺寸变化：自适应（custom 模式不变）
    window.addEventListener("resize", () => { if (mode !== "custom") render(); });

    // 加载
    (async function init() {
      try {
        const task = pdfjsLib.getDocument(PDF_URL);
        pdf = await task.promise;
        current = 1;
        mode = "fitWidth";
        await render();
      } catch (e) {
        // 仅打印控制台，不在页面显示任何文字
        console.error("PDF 加载失败：", e);
      }
    })();
  </script>
</body>
</html>
